/**
 * @file mix2.c
 * 
 * @date 2020-01-14
 * @author twatorowski 
 * 
 * @brief 2nd stage mixer, that brings the decimated signal to DC. This one has 
 * a lot finer tunning capabilities as it uses NCO with bigger look-up table and 
 * operates as low-data rate.
 */

#include <stdint.h>

#include "assert.h"
#include "compiler.h"
#include "config.h"
#include "util/elems.h"

/* cosine look-up table, 256 samples, full scale */
static const int16_t cos_lut[] = {
   +0x7fff, +0x7ff5, +0x7fd7, +0x7fa6, +0x7f61, +0x7f08, +0x7e9c, +0x7e1c,
   +0x7d89, +0x7ce2, +0x7c29, +0x7b5c, +0x7a7c, +0x7989, +0x7883, +0x776b,
   +0x7640, +0x7503, +0x73b5, +0x7254, +0x70e1, +0x6f5e, +0x6dc9, +0x6c23,
   +0x6a6c, +0x68a5, +0x66ce, +0x64e7, +0x62f1, +0x60eb, +0x5ed6, +0x5cb3,
   +0x5a81, +0x5842, +0x55f4, +0x539a, +0x5133, +0x4ebf, +0x4c3f, +0x49b3,
   +0x471c, +0x447a, +0x41cd, +0x3f16, +0x3c56, +0x398c, +0x36b9, +0x33de,
   +0x30fb, +0x2e10, +0x2b1e, +0x2826, +0x2527, +0x2223, +0x1f19, +0x1c0b,
   +0x18f8, +0x15e1, +0x12c7, +0x0fab, +0x0c8b, +0x096a, +0x0647, +0x0324,
   +0x0000, -0x0324, -0x0647, -0x096a, -0x0c8b, -0x0fab, -0x12c7, -0x15e1,
   -0x18f8, -0x1c0b, -0x1f19, -0x2223, -0x2527, -0x2826, -0x2b1e, -0x2e10,
   -0x30fb, -0x33de, -0x36b9, -0x398c, -0x3c56, -0x3f16, -0x41cd, -0x447a,
   -0x471c, -0x49b3, -0x4c3f, -0x4ebf, -0x5133, -0x539a, -0x55f4, -0x5842,
   -0x5a81, -0x5cb3, -0x5ed6, -0x60eb, -0x62f1, -0x64e7, -0x66ce, -0x68a5,
   -0x6a6c, -0x6c23, -0x6dc9, -0x6f5e, -0x70e1, -0x7254, -0x73b5, -0x7503,
   -0x7640, -0x776b, -0x7883, -0x7989, -0x7a7c, -0x7b5c, -0x7c29, -0x7ce2,
   -0x7d89, -0x7e1c, -0x7e9c, -0x7f08, -0x7f61, -0x7fa6, -0x7fd7, -0x7ff5,
   -0x7fff, -0x7ff5, -0x7fd7, -0x7fa6, -0x7f61, -0x7f08, -0x7e9c, -0x7e1c,
   -0x7d89, -0x7ce2, -0x7c29, -0x7b5c, -0x7a7c, -0x7989, -0x7883, -0x776b,
   -0x7640, -0x7503, -0x73b5, -0x7254, -0x70e1, -0x6f5e, -0x6dc9, -0x6c23,
   -0x6a6c, -0x68a5, -0x66ce, -0x64e7, -0x62f1, -0x60eb, -0x5ed6, -0x5cb3,
   -0x5a81, -0x5842, -0x55f4, -0x539a, -0x5133, -0x4ebf, -0x4c3f, -0x49b3,
   -0x471c, -0x447a, -0x41cd, -0x3f16, -0x3c56, -0x398c, -0x36b9, -0x33de,
   -0x30fb, -0x2e10, -0x2b1e, -0x2826, -0x2527, -0x2223, -0x1f19, -0x1c0b,
   -0x18f8, -0x15e1, -0x12c7, -0x0fab, -0x0c8b, -0x096a, -0x0647, -0x0324,
   +0x0000, +0x0324, +0x0647, +0x096a, +0x0c8b, +0x0fab, +0x12c7, +0x15e1,
   +0x18f8, +0x1c0b, +0x1f19, +0x2223, +0x2527, +0x2826, +0x2b1e, +0x2e10,
   +0x30fb, +0x33de, +0x36b9, +0x398c, +0x3c56, +0x3f16, +0x41cd, +0x447a,
   +0x471c, +0x49b3, +0x4c3f, +0x4ebf, +0x5133, +0x539a, +0x55f4, +0x5842,
   +0x5a81, +0x5cb3, +0x5ed6, +0x60eb, +0x62f1, +0x64e7, +0x66ce, +0x68a5,
   +0x6a6c, +0x6c23, +0x6dc9, +0x6f5e, +0x70e1, +0x7254, +0x73b5, +0x7503,
   +0x7640, +0x776b, +0x7883, +0x7989, +0x7a7c, +0x7b5c, +0x7c29, +0x7ce2,
   +0x7d89, +0x7e1c, +0x7e9c, +0x7f08, +0x7f61, +0x7fa6, +0x7fd7, +0x7ff5,
};

/* phase counters for both: in-phase and quadrature components */
static uint8_t i_pc, q_pc;
/* currently selected band */
static uint8_t curr_band;

/* do the mixing */
void Mix2_Mix(const int32_t *i, const int32_t *q, int num, 
    int32_t *i_out, int32_t *q_out)
{
    /* temporary variables */
    int64_t _i, _q;
    /* process all of the input data */
    for (int cnt = 0; cnt < num; cnt++, i_pc += curr_band, q_pc += curr_band) {
        /* complex multiplication */
        _i = (int64_t)i[cnt] * cos_lut[i_pc] + (int64_t)q[cnt] * cos_lut[q_pc];
        _q = (int64_t)q[cnt] * cos_lut[q_pc] - (int64_t)i[cnt] * cos_lut[q_pc];
        /* downconvert */
        i_out[cnt] = _i >> 15, q_out[cnt] = _q >> 15;
    }
}

/* set the current lo frequency */
int Mix2_SetLOFrequency(int hz)
{
    /* get the actual frequency */
    int band = (elems(cos_lut) * hz * DEC_DECIMATION_RATE + 
        (RF_SAMPLING_FREQ / 2)) / RF_SAMPLING_FREQ;
    
    /* sanity check */
    assert(band > -(int)elems(cos_lut) / 2 && band <= (int)elems(cos_lut) / 2, 
        "unsupported band for mix2", band);
    /* store current band */
    curr_band = band;
    /* return the actual frequency */
    return band * RF_SAMPLING_FREQ / DEC_DECIMATION_RATE * elems(cos_lut);
}