/**
 * @file mix2.c
 * 
 * @date 2020-01-19
 * @author twatorowski 
 * 
 * @brief 2nd stage mixer. Uses floating point arithmetic
 */

#include "assert.h"
#include "compiler.h"
#include "config.h"
#include "err.h"
#include "sys/critical.h"
#include "util/elems.h"
#include "util/fp.h"

#define DEBUG
#include "debug.h"

/* cosine look up table */
static const float cos_lut[] = {
    +1.000000e+00, +9.999812e-01, +9.999247e-01, +9.998306e-01,
    +9.996988e-01, +9.995294e-01, +9.993224e-01, +9.990777e-01,
    +9.987955e-01, +9.984756e-01, +9.981181e-01, +9.977231e-01,
    +9.972905e-01, +9.968203e-01, +9.963126e-01, +9.957674e-01,
    +9.951847e-01, +9.945646e-01, +9.939070e-01, +9.932119e-01,
    +9.924795e-01, +9.917098e-01, +9.909026e-01, +9.900582e-01,
    +9.891765e-01, +9.882576e-01, +9.873014e-01, +9.863081e-01,
    +9.852776e-01, +9.842101e-01, +9.831055e-01, +9.819639e-01,
    +9.807853e-01, +9.795698e-01, +9.783174e-01, +9.770281e-01,
    +9.757021e-01, +9.743394e-01, +9.729400e-01, +9.715039e-01,
    +9.700313e-01, +9.685221e-01, +9.669765e-01, +9.653944e-01,
    +9.637761e-01, +9.621214e-01, +9.604305e-01, +9.587035e-01,
    +9.569403e-01, +9.551412e-01, +9.533060e-01, +9.514350e-01,
    +9.495282e-01, +9.475856e-01, +9.456073e-01, +9.435935e-01,
    +9.415441e-01, +9.394592e-01, +9.373390e-01, +9.351835e-01,
    +9.329928e-01, +9.307670e-01, +9.285061e-01, +9.262102e-01,
    +9.238795e-01, +9.215140e-01, +9.191139e-01, +9.166791e-01,
    +9.142098e-01, +9.117060e-01, +9.091680e-01, +9.065957e-01,
    +9.039893e-01, +9.013488e-01, +8.986745e-01, +8.959662e-01,
    +8.932243e-01, +8.904487e-01, +8.876396e-01, +8.847971e-01,
    +8.819213e-01, +8.790122e-01, +8.760701e-01, +8.730950e-01,
    +8.700870e-01, +8.670462e-01, +8.639729e-01, +8.608669e-01,
    +8.577286e-01, +8.545580e-01, +8.513552e-01, +8.481203e-01,
    +8.448536e-01, +8.415550e-01, +8.382247e-01, +8.348629e-01,
    +8.314696e-01, +8.280450e-01, +8.245893e-01, +8.211025e-01,
    +8.175848e-01, +8.140363e-01, +8.104572e-01, +8.068476e-01,
    +8.032075e-01, +7.995373e-01, +7.958369e-01, +7.921066e-01,
    +7.883464e-01, +7.845566e-01, +7.807372e-01, +7.768885e-01,
    +7.730105e-01, +7.691033e-01, +7.651673e-01, +7.612024e-01,
    +7.572088e-01, +7.531868e-01, +7.491364e-01, +7.450578e-01,
    +7.409511e-01, +7.368166e-01, +7.326543e-01, +7.284644e-01,
    +7.242471e-01, +7.200025e-01, +7.157308e-01, +7.114322e-01,
    +7.071068e-01, +7.027547e-01, +6.983762e-01, +6.939715e-01,
    +6.895405e-01, +6.850837e-01, +6.806010e-01, +6.760927e-01,
    +6.715590e-01, +6.669999e-01, +6.624158e-01, +6.578067e-01,
    +6.531728e-01, +6.485144e-01, +6.438315e-01, +6.391244e-01,
    +6.343933e-01, +6.296382e-01, +6.248595e-01, +6.200572e-01,
    +6.152316e-01, +6.103828e-01, +6.055110e-01, +6.006165e-01,
    +5.956993e-01, +5.907597e-01, +5.857979e-01, +5.808140e-01,
    +5.758082e-01, +5.707807e-01, +5.657318e-01, +5.606616e-01,
    +5.555702e-01, +5.504580e-01, +5.453250e-01, +5.401715e-01,
    +5.349976e-01, +5.298036e-01, +5.245897e-01, +5.193560e-01,
    +5.141027e-01, +5.088301e-01, +5.035384e-01, +4.982277e-01,
    +4.928982e-01, +4.875502e-01, +4.821838e-01, +4.767992e-01,
    +4.713967e-01, +4.659765e-01, +4.605387e-01, +4.550836e-01,
    +4.496113e-01, +4.441221e-01, +4.386162e-01, +4.330938e-01,
    +4.275551e-01, +4.220003e-01, +4.164296e-01, +4.108432e-01,
    +4.052413e-01, +3.996242e-01, +3.939920e-01, +3.883450e-01,
    +3.826834e-01, +3.770074e-01, +3.713172e-01, +3.656130e-01,
    +3.598950e-01, +3.541635e-01, +3.484187e-01, +3.426607e-01,
    +3.368899e-01, +3.311063e-01, +3.253103e-01, +3.195020e-01,
    +3.136817e-01, +3.078496e-01, +3.020059e-01, +2.961509e-01,
    +2.902847e-01, +2.844075e-01, +2.785197e-01, +2.726214e-01,
    +2.667128e-01, +2.607941e-01, +2.548657e-01, +2.489276e-01,
    +2.429802e-01, +2.370236e-01, +2.310581e-01, +2.250839e-01,
    +2.191012e-01, +2.131103e-01, +2.071114e-01, +2.011046e-01,
    +1.950903e-01, +1.890687e-01, +1.830399e-01, +1.770042e-01,
    +1.709619e-01, +1.649131e-01, +1.588581e-01, +1.527972e-01,
    +1.467305e-01, +1.406582e-01, +1.345807e-01, +1.284981e-01,
    +1.224107e-01, +1.163186e-01, +1.102222e-01, +1.041216e-01,
    +9.801714e-02, +9.190896e-02, +8.579731e-02, +7.968244e-02,
    +7.356456e-02, +6.744392e-02, +6.132074e-02, +5.519524e-02,
    +4.906767e-02, +4.293826e-02, +3.680722e-02, +3.067480e-02,
    +2.454123e-02, +1.840673e-02, +1.227154e-02, +6.135885e-03,
    +6.123234e-17, -6.135885e-03, -1.227154e-02, -1.840673e-02,
    -2.454123e-02, -3.067480e-02, -3.680722e-02, -4.293826e-02,
    -4.906767e-02, -5.519524e-02, -6.132074e-02, -6.744392e-02,
    -7.356456e-02, -7.968244e-02, -8.579731e-02, -9.190896e-02,
    -9.801714e-02, -1.041216e-01, -1.102222e-01, -1.163186e-01,
    -1.224107e-01, -1.284981e-01, -1.345807e-01, -1.406582e-01,
    -1.467305e-01, -1.527972e-01, -1.588581e-01, -1.649131e-01,
    -1.709619e-01, -1.770042e-01, -1.830399e-01, -1.890687e-01,
    -1.950903e-01, -2.011046e-01, -2.071114e-01, -2.131103e-01,
    -2.191012e-01, -2.250839e-01, -2.310581e-01, -2.370236e-01,
    -2.429802e-01, -2.489276e-01, -2.548657e-01, -2.607941e-01,
    -2.667128e-01, -2.726214e-01, -2.785197e-01, -2.844075e-01,
    -2.902847e-01, -2.961509e-01, -3.020059e-01, -3.078496e-01,
    -3.136817e-01, -3.195020e-01, -3.253103e-01, -3.311063e-01,
    -3.368899e-01, -3.426607e-01, -3.484187e-01, -3.541635e-01,
    -3.598950e-01, -3.656130e-01, -3.713172e-01, -3.770074e-01,
    -3.826834e-01, -3.883450e-01, -3.939920e-01, -3.996242e-01,
    -4.052413e-01, -4.108432e-01, -4.164296e-01, -4.220003e-01,
    -4.275551e-01, -4.330938e-01, -4.386162e-01, -4.441221e-01,
    -4.496113e-01, -4.550836e-01, -4.605387e-01, -4.659765e-01,
    -4.713967e-01, -4.767992e-01, -4.821838e-01, -4.875502e-01,
    -4.928982e-01, -4.982277e-01, -5.035384e-01, -5.088301e-01,
    -5.141027e-01, -5.193560e-01, -5.245897e-01, -5.298036e-01,
    -5.349976e-01, -5.401715e-01, -5.453250e-01, -5.504580e-01,
    -5.555702e-01, -5.606616e-01, -5.657318e-01, -5.707807e-01,
    -5.758082e-01, -5.808140e-01, -5.857979e-01, -5.907597e-01,
    -5.956993e-01, -6.006165e-01, -6.055110e-01, -6.103828e-01,
    -6.152316e-01, -6.200572e-01, -6.248595e-01, -6.296382e-01,
    -6.343933e-01, -6.391244e-01, -6.438315e-01, -6.485144e-01,
    -6.531728e-01, -6.578067e-01, -6.624158e-01, -6.669999e-01,
    -6.715590e-01, -6.760927e-01, -6.806010e-01, -6.850837e-01,
    -6.895405e-01, -6.939715e-01, -6.983762e-01, -7.027547e-01,
    -7.071068e-01, -7.114322e-01, -7.157308e-01, -7.200025e-01,
    -7.242471e-01, -7.284644e-01, -7.326543e-01, -7.368166e-01,
    -7.409511e-01, -7.450578e-01, -7.491364e-01, -7.531868e-01,
    -7.572088e-01, -7.612024e-01, -7.651673e-01, -7.691033e-01,
    -7.730105e-01, -7.768885e-01, -7.807372e-01, -7.845566e-01,
    -7.883464e-01, -7.921066e-01, -7.958369e-01, -7.995373e-01,
    -8.032075e-01, -8.068476e-01, -8.104572e-01, -8.140363e-01,
    -8.175848e-01, -8.211025e-01, -8.245893e-01, -8.280450e-01,
    -8.314696e-01, -8.348629e-01, -8.382247e-01, -8.415550e-01,
    -8.448536e-01, -8.481203e-01, -8.513552e-01, -8.545580e-01,
    -8.577286e-01, -8.608669e-01, -8.639729e-01, -8.670462e-01,
    -8.700870e-01, -8.730950e-01, -8.760701e-01, -8.790122e-01,
    -8.819213e-01, -8.847971e-01, -8.876396e-01, -8.904487e-01,
    -8.932243e-01, -8.959662e-01, -8.986745e-01, -9.013488e-01,
    -9.039893e-01, -9.065957e-01, -9.091680e-01, -9.117060e-01,
    -9.142098e-01, -9.166791e-01, -9.191139e-01, -9.215140e-01,
    -9.238795e-01, -9.262102e-01, -9.285061e-01, -9.307670e-01,
    -9.329928e-01, -9.351835e-01, -9.373390e-01, -9.394592e-01,
    -9.415441e-01, -9.435935e-01, -9.456073e-01, -9.475856e-01,
    -9.495282e-01, -9.514350e-01, -9.533060e-01, -9.551412e-01,
    -9.569403e-01, -9.587035e-01, -9.604305e-01, -9.621214e-01,
    -9.637761e-01, -9.653944e-01, -9.669765e-01, -9.685221e-01,
    -9.700313e-01, -9.715039e-01, -9.729400e-01, -9.743394e-01,
    -9.757021e-01, -9.770281e-01, -9.783174e-01, -9.795698e-01,
    -9.807853e-01, -9.819639e-01, -9.831055e-01, -9.842101e-01,
    -9.852776e-01, -9.863081e-01, -9.873014e-01, -9.882576e-01,
    -9.891765e-01, -9.900582e-01, -9.909026e-01, -9.917098e-01,
    -9.924795e-01, -9.932119e-01, -9.939070e-01, -9.945646e-01,
    -9.951847e-01, -9.957674e-01, -9.963126e-01, -9.968203e-01,
    -9.972905e-01, -9.977231e-01, -9.981181e-01, -9.984756e-01,
    -9.987955e-01, -9.990777e-01, -9.993224e-01, -9.995294e-01,
    -9.996988e-01, -9.998306e-01, -9.999247e-01, -9.999812e-01,
    -1.000000e+00, -9.999812e-01, -9.999247e-01, -9.998306e-01,
    -9.996988e-01, -9.995294e-01, -9.993224e-01, -9.990777e-01,
    -9.987955e-01, -9.984756e-01, -9.981181e-01, -9.977231e-01,
    -9.972905e-01, -9.968203e-01, -9.963126e-01, -9.957674e-01,
    -9.951847e-01, -9.945646e-01, -9.939070e-01, -9.932119e-01,
    -9.924795e-01, -9.917098e-01, -9.909026e-01, -9.900582e-01,
    -9.891765e-01, -9.882576e-01, -9.873014e-01, -9.863081e-01,
    -9.852776e-01, -9.842101e-01, -9.831055e-01, -9.819639e-01,
    -9.807853e-01, -9.795698e-01, -9.783174e-01, -9.770281e-01,
    -9.757021e-01, -9.743394e-01, -9.729400e-01, -9.715039e-01,
    -9.700313e-01, -9.685221e-01, -9.669765e-01, -9.653944e-01,
    -9.637761e-01, -9.621214e-01, -9.604305e-01, -9.587035e-01,
    -9.569403e-01, -9.551412e-01, -9.533060e-01, -9.514350e-01,
    -9.495282e-01, -9.475856e-01, -9.456073e-01, -9.435935e-01,
    -9.415441e-01, -9.394592e-01, -9.373390e-01, -9.351835e-01,
    -9.329928e-01, -9.307670e-01, -9.285061e-01, -9.262102e-01,
    -9.238795e-01, -9.215140e-01, -9.191139e-01, -9.166791e-01,
    -9.142098e-01, -9.117060e-01, -9.091680e-01, -9.065957e-01,
    -9.039893e-01, -9.013488e-01, -8.986745e-01, -8.959662e-01,
    -8.932243e-01, -8.904487e-01, -8.876396e-01, -8.847971e-01,
    -8.819213e-01, -8.790122e-01, -8.760701e-01, -8.730950e-01,
    -8.700870e-01, -8.670462e-01, -8.639729e-01, -8.608669e-01,
    -8.577286e-01, -8.545580e-01, -8.513552e-01, -8.481203e-01,
    -8.448536e-01, -8.415550e-01, -8.382247e-01, -8.348629e-01,
    -8.314696e-01, -8.280450e-01, -8.245893e-01, -8.211025e-01,
    -8.175848e-01, -8.140363e-01, -8.104572e-01, -8.068476e-01,
    -8.032075e-01, -7.995373e-01, -7.958369e-01, -7.921066e-01,
    -7.883464e-01, -7.845566e-01, -7.807372e-01, -7.768885e-01,
    -7.730105e-01, -7.691033e-01, -7.651673e-01, -7.612024e-01,
    -7.572088e-01, -7.531868e-01, -7.491364e-01, -7.450578e-01,
    -7.409511e-01, -7.368166e-01, -7.326543e-01, -7.284644e-01,
    -7.242471e-01, -7.200025e-01, -7.157308e-01, -7.114322e-01,
    -7.071068e-01, -7.027547e-01, -6.983762e-01, -6.939715e-01,
    -6.895405e-01, -6.850837e-01, -6.806010e-01, -6.760927e-01,
    -6.715590e-01, -6.669999e-01, -6.624158e-01, -6.578067e-01,
    -6.531728e-01, -6.485144e-01, -6.438315e-01, -6.391244e-01,
    -6.343933e-01, -6.296382e-01, -6.248595e-01, -6.200572e-01,
    -6.152316e-01, -6.103828e-01, -6.055110e-01, -6.006165e-01,
    -5.956993e-01, -5.907597e-01, -5.857979e-01, -5.808140e-01,
    -5.758082e-01, -5.707807e-01, -5.657318e-01, -5.606616e-01,
    -5.555702e-01, -5.504580e-01, -5.453250e-01, -5.401715e-01,
    -5.349976e-01, -5.298036e-01, -5.245897e-01, -5.193560e-01,
    -5.141027e-01, -5.088301e-01, -5.035384e-01, -4.982277e-01,
    -4.928982e-01, -4.875502e-01, -4.821838e-01, -4.767992e-01,
    -4.713967e-01, -4.659765e-01, -4.605387e-01, -4.550836e-01,
    -4.496113e-01, -4.441221e-01, -4.386162e-01, -4.330938e-01,
    -4.275551e-01, -4.220003e-01, -4.164296e-01, -4.108432e-01,
    -4.052413e-01, -3.996242e-01, -3.939920e-01, -3.883450e-01,
    -3.826834e-01, -3.770074e-01, -3.713172e-01, -3.656130e-01,
    -3.598950e-01, -3.541635e-01, -3.484187e-01, -3.426607e-01,
    -3.368899e-01, -3.311063e-01, -3.253103e-01, -3.195020e-01,
    -3.136817e-01, -3.078496e-01, -3.020059e-01, -2.961509e-01,
    -2.902847e-01, -2.844075e-01, -2.785197e-01, -2.726214e-01,
    -2.667128e-01, -2.607941e-01, -2.548657e-01, -2.489276e-01,
    -2.429802e-01, -2.370236e-01, -2.310581e-01, -2.250839e-01,
    -2.191012e-01, -2.131103e-01, -2.071114e-01, -2.011046e-01,
    -1.950903e-01, -1.890687e-01, -1.830399e-01, -1.770042e-01,
    -1.709619e-01, -1.649131e-01, -1.588581e-01, -1.527972e-01,
    -1.467305e-01, -1.406582e-01, -1.345807e-01, -1.284981e-01,
    -1.224107e-01, -1.163186e-01, -1.102222e-01, -1.041216e-01,
    -9.801714e-02, -9.190896e-02, -8.579731e-02, -7.968244e-02,
    -7.356456e-02, -6.744392e-02, -6.132074e-02, -5.519524e-02,
    -4.906767e-02, -4.293826e-02, -3.680722e-02, -3.067480e-02,
    -2.454123e-02, -1.840673e-02, -1.227154e-02, -6.135885e-03,
    -1.836970e-16, +6.135885e-03, +1.227154e-02, +1.840673e-02,
    +2.454123e-02, +3.067480e-02, +3.680722e-02, +4.293826e-02,
    +4.906767e-02, +5.519524e-02, +6.132074e-02, +6.744392e-02,
    +7.356456e-02, +7.968244e-02, +8.579731e-02, +9.190896e-02,
    +9.801714e-02, +1.041216e-01, +1.102222e-01, +1.163186e-01,
    +1.224107e-01, +1.284981e-01, +1.345807e-01, +1.406582e-01,
    +1.467305e-01, +1.527972e-01, +1.588581e-01, +1.649131e-01,
    +1.709619e-01, +1.770042e-01, +1.830399e-01, +1.890687e-01,
    +1.950903e-01, +2.011046e-01, +2.071114e-01, +2.131103e-01,
    +2.191012e-01, +2.250839e-01, +2.310581e-01, +2.370236e-01,
    +2.429802e-01, +2.489276e-01, +2.548657e-01, +2.607941e-01,
    +2.667128e-01, +2.726214e-01, +2.785197e-01, +2.844075e-01,
    +2.902847e-01, +2.961509e-01, +3.020059e-01, +3.078496e-01,
    +3.136817e-01, +3.195020e-01, +3.253103e-01, +3.311063e-01,
    +3.368899e-01, +3.426607e-01, +3.484187e-01, +3.541635e-01,
    +3.598950e-01, +3.656130e-01, +3.713172e-01, +3.770074e-01,
    +3.826834e-01, +3.883450e-01, +3.939920e-01, +3.996242e-01,
    +4.052413e-01, +4.108432e-01, +4.164296e-01, +4.220003e-01,
    +4.275551e-01, +4.330938e-01, +4.386162e-01, +4.441221e-01,
    +4.496113e-01, +4.550836e-01, +4.605387e-01, +4.659765e-01,
    +4.713967e-01, +4.767992e-01, +4.821838e-01, +4.875502e-01,
    +4.928982e-01, +4.982277e-01, +5.035384e-01, +5.088301e-01,
    +5.141027e-01, +5.193560e-01, +5.245897e-01, +5.298036e-01,
    +5.349976e-01, +5.401715e-01, +5.453250e-01, +5.504580e-01,
    +5.555702e-01, +5.606616e-01, +5.657318e-01, +5.707807e-01,
    +5.758082e-01, +5.808140e-01, +5.857979e-01, +5.907597e-01,
    +5.956993e-01, +6.006165e-01, +6.055110e-01, +6.103828e-01,
    +6.152316e-01, +6.200572e-01, +6.248595e-01, +6.296382e-01,
    +6.343933e-01, +6.391244e-01, +6.438315e-01, +6.485144e-01,
    +6.531728e-01, +6.578067e-01, +6.624158e-01, +6.669999e-01,
    +6.715590e-01, +6.760927e-01, +6.806010e-01, +6.850837e-01,
    +6.895405e-01, +6.939715e-01, +6.983762e-01, +7.027547e-01,
    +7.071068e-01, +7.114322e-01, +7.157308e-01, +7.200025e-01,
    +7.242471e-01, +7.284644e-01, +7.326543e-01, +7.368166e-01,
    +7.409511e-01, +7.450578e-01, +7.491364e-01, +7.531868e-01,
    +7.572088e-01, +7.612024e-01, +7.651673e-01, +7.691033e-01,
    +7.730105e-01, +7.768885e-01, +7.807372e-01, +7.845566e-01,
    +7.883464e-01, +7.921066e-01, +7.958369e-01, +7.995373e-01,
    +8.032075e-01, +8.068476e-01, +8.104572e-01, +8.140363e-01,
    +8.175848e-01, +8.211025e-01, +8.245893e-01, +8.280450e-01,
    +8.314696e-01, +8.348629e-01, +8.382247e-01, +8.415550e-01,
    +8.448536e-01, +8.481203e-01, +8.513552e-01, +8.545580e-01,
    +8.577286e-01, +8.608669e-01, +8.639729e-01, +8.670462e-01,
    +8.700870e-01, +8.730950e-01, +8.760701e-01, +8.790122e-01,
    +8.819213e-01, +8.847971e-01, +8.876396e-01, +8.904487e-01,
    +8.932243e-01, +8.959662e-01, +8.986745e-01, +9.013488e-01,
    +9.039893e-01, +9.065957e-01, +9.091680e-01, +9.117060e-01,
    +9.142098e-01, +9.166791e-01, +9.191139e-01, +9.215140e-01,
    +9.238795e-01, +9.262102e-01, +9.285061e-01, +9.307670e-01,
    +9.329928e-01, +9.351835e-01, +9.373390e-01, +9.394592e-01,
    +9.415441e-01, +9.435935e-01, +9.456073e-01, +9.475856e-01,
    +9.495282e-01, +9.514350e-01, +9.533060e-01, +9.551412e-01,
    +9.569403e-01, +9.587035e-01, +9.604305e-01, +9.621214e-01,
    +9.637761e-01, +9.653944e-01, +9.669765e-01, +9.685221e-01,
    +9.700313e-01, +9.715039e-01, +9.729400e-01, +9.743394e-01,
    +9.757021e-01, +9.770281e-01, +9.783174e-01, +9.795698e-01,
    +9.807853e-01, +9.819639e-01, +9.831055e-01, +9.842101e-01,
    +9.852776e-01, +9.863081e-01, +9.873014e-01, +9.882576e-01,
    +9.891765e-01, +9.900582e-01, +9.909026e-01, +9.917098e-01,
    +9.924795e-01, +9.932119e-01, +9.939070e-01, +9.945646e-01,
    +9.951847e-01, +9.957674e-01, +9.963126e-01, +9.968203e-01,
    +9.972905e-01, +9.977231e-01, +9.981181e-01, +9.984756e-01,
    +9.987955e-01, +9.990777e-01, +9.993224e-01, +9.995294e-01,
    +9.996988e-01, +9.998306e-01, +9.999247e-01, +9.999812e-01,
};

/* currently selected band */
static int curr_band;
/* phase accumulator */
static unsigned int phase;

/* mix the rf signal with the local oscillator, rf is assumed to be of length 
 * equal to the length of the local oscillator lut */
void OPTIMIZE("O3") Mix2_Mix(const float *i, const float *q, 
    int num, float *i_out, float *q_out)
{
    /* temporary storage */
    float _i, _q, i_lut, q_lut;

    /* do the complex multiplication */
    for (int cnt = 0; cnt < num; cnt++, phase = (phase + curr_band) % elems(cos_lut)) {
        /* lut entries */
        i_lut = cos_lut[phase];
        q_lut = cos_lut[(phase + elems(cos_lut) / 4) % elems(cos_lut)];
        /* (a + bi) * (c + di) = (ac - bd) + i(ad + bc) */
        _i = i[cnt] * i_lut - q[cnt] * q_lut;
        _q = i[cnt] * q_lut + q[cnt] * i_lut;
        /* using temporary registers allows for in-situ operation */
        i_out[cnt] = _i, q_out[cnt] = _q;
    }
}

/* set the current lo frequency */
float Mix2_SetLOFrequency(float f)
{
    /* determine band spacing offered by the second lo */
    const float band_spacing = (float)RF_SAMPLING_FREQ / DEC_DECIMATION_RATE / 
        elems(cos_lut);
    /* get the actual band */
    int band = fp_round(f / band_spacing);

    /* sanity check */
    assert(band > -(int)elems(cos_lut) / 2 && band <= (int)elems(cos_lut) / 2, 
        "unsupported band for mix2", band);

    /* store current band */
    curr_band = band;
    /* return the actual frequency */
    return band * band_spacing;
}