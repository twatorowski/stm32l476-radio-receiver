/**
 * @file dec.c
 * 
 * @date 2020-01-12
 * @author twatorowski 
 * 
 * @brief Test routine for the decimators
 */

#include "compiler.h"
#include "err.h"
#include "dev/deci.h"
#include "dev/decq.h"
#include "util/elems.h"

#define DEBUG
#include "debug.h"

/* sinusoidal look up table */
static const int16_t ALIGNED(4) sine_lut[] = {
   +0x0000, +0x0324, +0x0647, +0x096a, +0x0c8b, +0x0fab, +0x12c7, +0x15e1,
   +0x18f8, +0x1c0b, +0x1f19, +0x2223, +0x2527, +0x2826, +0x2b1e, +0x2e10,
   +0x30fb, +0x33de, +0x36b9, +0x398c, +0x3c56, +0x3f16, +0x41cd, +0x447a,
   +0x471c, +0x49b3, +0x4c3f, +0x4ebf, +0x5133, +0x539a, +0x55f4, +0x5842,
   +0x5a81, +0x5cb3, +0x5ed6, +0x60eb, +0x62f1, +0x64e7, +0x66ce, +0x68a5,
   +0x6a6c, +0x6c23, +0x6dc9, +0x6f5e, +0x70e1, +0x7254, +0x73b5, +0x7503,
   +0x7640, +0x776b, +0x7883, +0x7989, +0x7a7c, +0x7b5c, +0x7c29, +0x7ce2,
   +0x7d89, +0x7e1c, +0x7e9c, +0x7f08, +0x7f61, +0x7fa6, +0x7fd7, +0x7ff5,
   +0x7fff, +0x7ff5, +0x7fd7, +0x7fa6, +0x7f61, +0x7f08, +0x7e9c, +0x7e1c,
   +0x7d89, +0x7ce2, +0x7c29, +0x7b5c, +0x7a7c, +0x7989, +0x7883, +0x776b,
   +0x7640, +0x7503, +0x73b5, +0x7254, +0x70e1, +0x6f5e, +0x6dc9, +0x6c23,
   +0x6a6c, +0x68a5, +0x66ce, +0x64e7, +0x62f1, +0x60eb, +0x5ed6, +0x5cb3,
   +0x5a81, +0x5842, +0x55f4, +0x539a, +0x5133, +0x4ebf, +0x4c3f, +0x49b3,
   +0x471c, +0x447a, +0x41cd, +0x3f16, +0x3c56, +0x398c, +0x36b9, +0x33de,
   +0x30fb, +0x2e10, +0x2b1e, +0x2826, +0x2527, +0x2223, +0x1f19, +0x1c0b,
   +0x18f8, +0x15e1, +0x12c7, +0x0fab, +0x0c8b, +0x096a, +0x0647, +0x0324,
   +0x0000, -0x0324, -0x0647, -0x096a, -0x0c8b, -0x0fab, -0x12c7, -0x15e1,
   -0x18f8, -0x1c0b, -0x1f19, -0x2223, -0x2527, -0x2826, -0x2b1e, -0x2e10,
   -0x30fb, -0x33de, -0x36b9, -0x398c, -0x3c56, -0x3f16, -0x41cd, -0x447a,
   -0x471c, -0x49b3, -0x4c3f, -0x4ebf, -0x5133, -0x539a, -0x55f4, -0x5842,
   -0x5a81, -0x5cb3, -0x5ed6, -0x60eb, -0x62f1, -0x64e7, -0x66ce, -0x68a5,
   -0x6a6c, -0x6c23, -0x6dc9, -0x6f5e, -0x70e1, -0x7254, -0x73b5, -0x7503,
   -0x7640, -0x776b, -0x7883, -0x7989, -0x7a7c, -0x7b5c, -0x7c29, -0x7ce2,
   -0x7d89, -0x7e1c, -0x7e9c, -0x7f08, -0x7f61, -0x7fa6, -0x7fd7, -0x7ff5,
   -0x7fff, -0x7ff5, -0x7fd7, -0x7fa6, -0x7f61, -0x7f08, -0x7e9c, -0x7e1c,
   -0x7d89, -0x7ce2, -0x7c29, -0x7b5c, -0x7a7c, -0x7989, -0x7883, -0x776b,
   -0x7640, -0x7503, -0x73b5, -0x7254, -0x70e1, -0x6f5e, -0x6dc9, -0x6c23,
   -0x6a6c, -0x68a5, -0x66ce, -0x64e7, -0x62f1, -0x60eb, -0x5ed6, -0x5cb3,
   -0x5a81, -0x5842, -0x55f4, -0x539a, -0x5133, -0x4ebf, -0x4c3f, -0x49b3,
   -0x471c, -0x447a, -0x41cd, -0x3f16, -0x3c56, -0x398c, -0x36b9, -0x33de,
   -0x30fb, -0x2e10, -0x2b1e, -0x2826, -0x2527, -0x2223, -0x1f19, -0x1c0b,
   -0x18f8, -0x15e1, -0x12c7, -0x0fab, -0x0c8b, -0x096a, -0x0647, -0x0324,
};

/* output results holding array */
static int32_t output[elems(sine_lut) / DEC_DECIMATION_RATE];

/* decimation complete callback*/
static int TestDec_DecQCallback(void *ptr)
{
    /* show message */
    dprintf("decimation using Q is complete\n", 0);
    /* report status */
    return EOK;
}
/* decimation complete callback*/
static int TestDec_DecICallback(void *ptr)
{
    /* show message */
    dprintf("decimation using I is complete\n", 0);
    /* decimate with q channel */
    DecQ_Decimate(sine_lut, elems(sine_lut), output,
        TestDec_DecQCallback);
    /* report status */
    return EOK;
}

/* test the decimators */
int TestDec_Init(void)
{   
    /* do the decimation */
    DecI_Decimate(sine_lut, elems(sine_lut), output,
        TestDec_DecICallback);
    /* report status */
    return EOK;
}

/* poll the decimation test */
void TestDec_Poll(void)
{
}