/**
 * @file dec.c
 * 
 * @date 2020-01-12
 * @author twatorowski 
 * 
 * @brief Test routine for the decimators
 */

#include "assert.h"
#include "compiler.h"
#include "err.h"
#include "dev/dec.h"
#include "util/elems.h"

#define DEBUG
#include "debug.h"

/* sinusoidal look up table */
static const uint16_t ALIGNED(4) sine_lut[] = {
    0x0000, 0x0080, 0x0101, 0x0181, 0x0202, 0x0282, 0x0302, 0x0382,
    0x0402, 0x0482, 0x0501, 0x0580, 0x05fe, 0x067d, 0x06fa, 0x0778,
    0x07f5, 0x0871, 0x08ed, 0x0968, 0x09e3, 0x0a5d, 0x0ad6, 0x0b4f,
    0x0bc7, 0x0c3e, 0x0cb5, 0x0d2a, 0x0d9f, 0x0e13, 0x0e86, 0x0ef8,
    0x0f6a, 0x0fda, 0x1049, 0x10b7, 0x1124, 0x1191, 0x11fc, 0x1265,
    0x12ce, 0x1336, 0x139c, 0x1401, 0x1465, 0x14c7, 0x1528, 0x1588,
    0x15e7, 0x1644, 0x169f, 0x16fa, 0x1752, 0x17aa, 0x1800, 0x1854,
    0x18a7, 0x18f8, 0x1948, 0x1996, 0x19e2, 0x1a2d, 0x1a76, 0x1abe,
    0x1b03, 0x1b47, 0x1b8a, 0x1bca, 0x1c09, 0x1c46, 0x1c82, 0x1cbb,
    0x1cf3, 0x1d29, 0x1d5d, 0x1d8f, 0x1dbf, 0x1dee, 0x1e1a, 0x1e45,
    0x1e6e, 0x1e94, 0x1eb9, 0x1edc, 0x1efd, 0x1f1c, 0x1f39, 0x1f54,
    0x1f6d, 0x1f85, 0x1f9a, 0x1fad, 0x1fbe, 0x1fcd, 0x1fda, 0x1fe5,
    0x1fee, 0x1ff5, 0x1ffa, 0x1ffd, 0x1fff, 0x1ffd, 0x1ffa, 0x1ff5,
    0x1fee, 0x1fe5, 0x1fda, 0x1fcd, 0x1fbe, 0x1fad, 0x1f9a, 0x1f85,
    0x1f6d, 0x1f54, 0x1f39, 0x1f1c, 0x1efd, 0x1edc, 0x1eb9, 0x1e94,
    0x1e6e, 0x1e45, 0x1e1a, 0x1dee, 0x1dbf, 0x1d8f, 0x1d5d, 0x1d29,
    0x1cf3, 0x1cbb, 0x1c82, 0x1c46, 0x1c09, 0x1bca, 0x1b8a, 0x1b47,
    0x1b03, 0x1abe, 0x1a76, 0x1a2d, 0x19e2, 0x1996, 0x1948, 0x18f8,
    0x18a7, 0x1854, 0x1800, 0x17aa, 0x1752, 0x16fa, 0x169f, 0x1644,
    0x15e7, 0x1588, 0x1528, 0x14c7, 0x1465, 0x1401, 0x139c, 0x1336,
    0x12ce, 0x1265, 0x11fc, 0x1191, 0x1124, 0x10b7, 0x1049, 0x0fda,
    0x0f6a, 0x0ef8, 0x0e86, 0x0e13, 0x0d9f, 0x0d2a, 0x0cb5, 0x0c3e,
    0x0bc7, 0x0b4f, 0x0ad6, 0x0a5d, 0x09e3, 0x0968, 0x08ed, 0x0871,
    0x07f5, 0x0778, 0x06fa, 0x067d, 0x05fe, 0x0580, 0x0501, 0x0482,
    0x0402, 0x0382, 0x0302, 0x0282, 0x0202, 0x0181, 0x0101, 0x0080,
    0x0000, 0xff80, 0xfeff, 0xfe7f, 0xfdfe, 0xfd7e, 0xfcfe, 0xfc7e,
    0xfbfe, 0xfb7e, 0xfaff, 0xfa80, 0xfa02, 0xf983, 0xf906, 0xf888,
    0xf80b, 0xf78f, 0xf713, 0xf698, 0xf61d, 0xf5a3, 0xf52a, 0xf4b1,
    0xf439, 0xf3c2, 0xf34b, 0xf2d6, 0xf261, 0xf1ed, 0xf17a, 0xf108,
    0xf096, 0xf026, 0xefb7, 0xef49, 0xeedc, 0xee6f, 0xee04, 0xed9b,
    0xed32, 0xecca, 0xec64, 0xebff, 0xeb9b, 0xeb39, 0xead8, 0xea78,
    0xea19, 0xe9bc, 0xe961, 0xe906, 0xe8ae, 0xe856, 0xe800, 0xe7ac,
    0xe759, 0xe708, 0xe6b8, 0xe66a, 0xe61e, 0xe5d3, 0xe58a, 0xe542,
    0xe4fd, 0xe4b9, 0xe476, 0xe436, 0xe3f7, 0xe3ba, 0xe37e, 0xe345,
    0xe30d, 0xe2d7, 0xe2a3, 0xe271, 0xe241, 0xe212, 0xe1e6, 0xe1bb,
    0xe192, 0xe16c, 0xe147, 0xe124, 0xe103, 0xe0e4, 0xe0c7, 0xe0ac,
    0xe093, 0xe07b, 0xe066, 0xe053, 0xe042, 0xe033, 0xe026, 0xe01b,
    0xe012, 0xe00b, 0xe006, 0xe003, 0xe001, 0xe003, 0xe006, 0xe00b,
    0xe012, 0xe01b, 0xe026, 0xe033, 0xe042, 0xe053, 0xe066, 0xe07b,
    0xe093, 0xe0ac, 0xe0c7, 0xe0e4, 0xe103, 0xe124, 0xe147, 0xe16c,
    0xe192, 0xe1bb, 0xe1e6, 0xe212, 0xe241, 0xe271, 0xe2a3, 0xe2d7,
    0xe30d, 0xe345, 0xe37e, 0xe3ba, 0xe3f7, 0xe436, 0xe476, 0xe4b9,
    0xe4fd, 0xe542, 0xe58a, 0xe5d3, 0xe61e, 0xe66a, 0xe6b8, 0xe708,
    0xe759, 0xe7ac, 0xe800, 0xe856, 0xe8ae, 0xe906, 0xe961, 0xe9bc,
    0xea19, 0xea78, 0xead8, 0xeb39, 0xeb9b, 0xebff, 0xec64, 0xecca,
    0xed32, 0xed9b, 0xee04, 0xee6f, 0xeedc, 0xef49, 0xefb7, 0xf026,
    0xf096, 0xf108, 0xf17a, 0xf1ed, 0xf261, 0xf2d6, 0xf34b, 0xf3c2,
    0xf439, 0xf4b1, 0xf52a, 0xf5a3, 0xf61d, 0xf698, 0xf713, 0xf78f,
    0xf80b, 0xf888, 0xf906, 0xf983, 0xfa02, 0xfa80, 0xfaff, 0xfb7e,
    0xfbfe, 0xfc7e, 0xfcfe, 0xfd7e, 0xfdfe, 0xfe7f, 0xfeff, 0xff80,
};

/* output results holding array */
static float i_out[elems(sine_lut) / DEC_DECIMATION_RATE];
static float q_out[elems(sine_lut) / DEC_DECIMATION_RATE];
/* decimation counter */
static int cnt = 0;

/* decimation callback */
static int TestDec_DecimationDoneCallback(void *ptr)
{
    /* check only the first the thousand of decimations */
    if (ptr && cnt < 10000) {
        /* compare two outputs */
        for (int i = 0; i < elems(i_out); i++) {
            /* compare */
            assert(i_out[i] == q_out[i], "decimated outputs differ", cnt);
            /* clear arrays */
            i_out[i] = q_out[i] = 0;
        }
        cnt++;
    }

    /* do the decimation */
    Dec_Decimate((int16_t * )sine_lut, (int16_t * )sine_lut, elems(sine_lut), 
        i_out, q_out, TestDec_DecimationDoneCallback);
    
    /* report status */
    return EOK;
}

/* test the decimators */
int TestDec_Init(void)
{   
    /* start process */
    Sem_Lock(&dec_sem, TestDec_DecimationDoneCallback);
    /* report status */
    return EOK;
}

/* poll the decimation test */
void TestDec_Poll(void)
{
}