/**
 * @file float_fixp.c
 * 
 * @date 2020-01-18
 * @author twatorowski 
 * 
 * @brief Test for the float-fixp conversion module
 */

#include "assert.h"
#include "err.h"
#include "dsp/float_fixp.h"
#include "util/elems.h"

#define DEBUG
#include "debug.h"

/* test data vector */
static const float f32[] = {
    -0x1.4248f0p+00, -0x1.0c5b50p+00, -0x1.bee796p-01, -0x1.741fa8p-01,
    -0x1.35db1ap-01, -0x1.0201e6p-01, -0x1.adab6ap-02, -0x1.65c5c8p-02,
    -0x1.29e7fap-02, -0x1.f01d50p-03, -0x1.9d1966p-03, -0x1.57f996p-03,
    -0x1.1e6ad4p-03, -0x1.dcfb4ep-04, -0x1.8d2afap-04, -0x1.4ab59cp-04,
    -0x1.135f1cp-04, -0x1.ca9630p-05, -0x1.7dd9d8p-05, -0x1.3df49ap-05,
    -0x1.08c070p-05, -0x1.b8e6b0p-06, -0x1.6f1feep-06, -0x1.31b184p-06,
    -0x1.fd153ap-07, -0x1.a7e5cap-07, -0x1.60f768p-07, -0x1.25e77cp-07,
    -0x1.e97330p-08, -0x1.978cc2p-08, -0x1.535aaap-08, -0x1.1a91d8p-08,
    -0x1.d692fap-09, -0x1.87d520p-09, -0x1.46444ep-09, -0x1.0fac1cp-09,
    -0x1.c46d1ep-10, -0x1.78b8aap-10, -0x1.39af2ap-10, -0x1.0531f6p-10,
    -0x1.b2fa70p-11, -0x1.6a3166p-11, -0x1.2d963ep-11, -0x1.f63e80p-12,
    -0x1.a23402p-12, -0x1.5c3990p-12, -0x1.21f4c0p-12, -0x1.e2dffap-13,
    -0x1.921334p-13, -0x1.4ecba2p-13, -0x1.16c618p-13, -0x1.d040aep-14,
    -0x1.82919ep-14, -0x1.41e248p-14, -0x1.0c05d6p-14, -0x1.be593cp-15,
    -0x1.73a920p-15, -0x1.357868p-15, -0x1.01afb8p-15, -0x1.ad228ep-16,
    -0x1.6553d2p-16, -0x1.298916p-16, -0x1.ef7f4ap-17, -0x1.9c95d2p-17,
    -0x1.578c06p-17, -0x1.1e0f9ap-17, -0x1.dc6360p-18, -0x1.8cac7ap-18,
    -0x1.4a4c46p-18, -0x1.130766p-18, -0x1.ca0420p-19, -0x1.7d6038p-19,
    -0x1.3d8f54p-19, -0x1.086c1cp-19, -0x1.b85a40p-20, -0x1.6eaafep-20,
    -0x1.315026p-20, -0x1.fc7312p-21, -0x1.a75ec4p-21, -0x1.6086fap-21,
    -0x1.2589dep-21, -0x1.e8d74ap-22, -0x1.970af2p-22, -0x1.52ee92p-22,
    -0x1.1a37d8p-22, -0x1.d5fd16p-23, -0x1.875852p-23, -0x1.45dc62p-23,
    -0x1.0f5594p-23, -0x1.c3dd04p-24, -0x1.7840acp-24, -0x1.394b40p-24,
    -0x1.04dec4p-24, -0x1.b26fe4p-25, -0x1.69be08p-25, -0x1.2d362ep-25,
    -0x1.f59e86p-26, -0x1.a1aecep-26, -0x1.5bcaa6p-26, -0x1.219866p-26,
    -0x1.e2462cp-27, -0x1.919322p-27, -0x1.4e60fep-27, -0x1.166d4cp-27,
    -0x1.cfaccep-28, -0x1.82167ep-28, -0x1.417bc2p-28, -0x1.0bb076p-28,
    -0x1.bdcb10p-29, -0x1.7332c0p-29, -0x1.3515d6p-29, -0x1.015da4p-29,
    -0x1.ac99dep-30, -0x1.64e202p-30, -0x1.292a52p-30, -0x1.eee178p-31,
    -0x1.9c1266p-31, -0x1.571e98p-31, -0x1.1db47cp-31, -0x1.dbcba4p-32,
    -0x1.8c2e20p-32, -0x1.49e312p-32, -0x1.12afccp-32, -0x1.c9723cp-33,
    -0x1.7ce6bep-33, -0x1.3d2a2ep-33, -0x1.0817e2p-33, -0x1.b7cdfep-34,
    +0x1.b7cdfep-34, +0x1.0817e2p-33, +0x1.3d2a2ep-33, +0x1.7ce6bep-33,
    +0x1.c9723cp-33, +0x1.12afccp-32, +0x1.49e312p-32, +0x1.8c2e20p-32,
    +0x1.dbcba4p-32, +0x1.1db47cp-31, +0x1.571e98p-31, +0x1.9c1266p-31,
    +0x1.eee178p-31, +0x1.292a52p-30, +0x1.64e202p-30, +0x1.ac99dep-30,
    +0x1.015da4p-29, +0x1.3515d6p-29, +0x1.7332c0p-29, +0x1.bdcb10p-29,
    +0x1.0bb076p-28, +0x1.417bc2p-28, +0x1.82167ep-28, +0x1.cfaccep-28,
    +0x1.166d4cp-27, +0x1.4e60fep-27, +0x1.919322p-27, +0x1.e2462cp-27,
    +0x1.219866p-26, +0x1.5bcaa6p-26, +0x1.a1aecep-26, +0x1.f59e86p-26,
    +0x1.2d362ep-25, +0x1.69be08p-25, +0x1.b26fe4p-25, +0x1.04dec4p-24,
    +0x1.394b40p-24, +0x1.7840acp-24, +0x1.c3dd04p-24, +0x1.0f5594p-23,
    +0x1.45dc62p-23, +0x1.875852p-23, +0x1.d5fd16p-23, +0x1.1a37d8p-22,
    +0x1.52ee92p-22, +0x1.970af2p-22, +0x1.e8d74ap-22, +0x1.2589dep-21,
    +0x1.6086fap-21, +0x1.a75ec4p-21, +0x1.fc7312p-21, +0x1.315026p-20,
    +0x1.6eaafep-20, +0x1.b85a40p-20, +0x1.086c1cp-19, +0x1.3d8f54p-19,
    +0x1.7d6038p-19, +0x1.ca0420p-19, +0x1.130766p-18, +0x1.4a4c46p-18,
    +0x1.8cac7ap-18, +0x1.dc6360p-18, +0x1.1e0f9ap-17, +0x1.578c06p-17,
    +0x1.9c95d2p-17, +0x1.ef7f4ap-17, +0x1.298916p-16, +0x1.6553d2p-16,
    +0x1.ad228ep-16, +0x1.01afb8p-15, +0x1.357868p-15, +0x1.73a920p-15,
    +0x1.be593cp-15, +0x1.0c05d6p-14, +0x1.41e248p-14, +0x1.82919ep-14,
    +0x1.d040aep-14, +0x1.16c618p-13, +0x1.4ecba2p-13, +0x1.921334p-13,
    +0x1.e2dffap-13, +0x1.21f4c0p-12, +0x1.5c3990p-12, +0x1.a23402p-12,
    +0x1.f63e80p-12, +0x1.2d963ep-11, +0x1.6a3166p-11, +0x1.b2fa70p-11,
    +0x1.0531f6p-10, +0x1.39af2ap-10, +0x1.78b8aap-10, +0x1.c46d1ep-10,
    +0x1.0fac1cp-09, +0x1.46444ep-09, +0x1.87d520p-09, +0x1.d692fap-09,
    +0x1.1a91d8p-08, +0x1.535aaap-08, +0x1.978cc2p-08, +0x1.e97330p-08,
    +0x1.25e77cp-07, +0x1.60f768p-07, +0x1.a7e5cap-07, +0x1.fd153ap-07,
    +0x1.31b184p-06, +0x1.6f1feep-06, +0x1.b8e6b0p-06, +0x1.08c070p-05,
    +0x1.3df49ap-05, +0x1.7dd9d8p-05, +0x1.ca9630p-05, +0x1.135f1cp-04,
    +0x1.4ab59cp-04, +0x1.8d2afap-04, +0x1.dcfb4ep-04, +0x1.1e6ad4p-03,
    +0x1.57f996p-03, +0x1.9d1966p-03, +0x1.f01d50p-03, +0x1.29e7fap-02,
    +0x1.65c5c8p-02, +0x1.adab6ap-02, +0x1.0201e6p-01, +0x1.35db1ap-01,
    +0x1.741fa8p-01, +0x1.bee796p-01, +0x1.0c5b50p+00, +0x1.4248f0p+00,
};

/* floating point numbers after the conversion from the int32 notation */
static const float f32_from_i32[] = {
    -0x1.0000000p-00, -0x1.0000000p-00, -0x1.bee7960p-01, -0x1.741fa80p-01,
    -0x1.35db1a0p-01, -0x1.0201e60p-01, -0x1.adab6a0p-02, -0x1.65c5c80p-02,
    -0x1.29e7fa0p-02, -0x1.f01d500p-03, -0x1.9d19660p-03, -0x1.57f9960p-03,
    -0x1.1e6ad40p-03, -0x1.dcfb4e0p-04, -0x1.8d2afa0p-04, -0x1.4ab59c0p-04,
    -0x1.135f1c0p-04, -0x1.ca96300p-05, -0x1.7dd9d80p-05, -0x1.3df49a0p-05,
    -0x1.08c0700p-05, -0x1.b8e6b00p-06, -0x1.6f1fee0p-06, -0x1.31b1840p-06,
    -0x1.fd153a0p-07, -0x1.a7e5ca0p-07, -0x1.60f7680p-07, -0x1.25e77c0p-07,
    -0x1.e973300p-08, -0x1.978cc20p-08, -0x1.535aaa0p-08, -0x1.1a91d80p-08,
    -0x1.d692f80p-09, -0x1.87d5200p-09, -0x1.46444c0p-09, -0x1.0fac1c0p-09,
    -0x1.c46d180p-10, -0x1.78b8a80p-10, -0x1.39af280p-10, -0x1.0531f00p-10,
    -0x1.b2fa700p-11, -0x1.6a31600p-11, -0x1.2d96300p-11, -0x1.f63e800p-12,
    -0x1.a234000p-12, -0x1.5c39800p-12, -0x1.21f4c00p-12, -0x1.e2dfc00p-13,
    -0x1.9213000p-13, -0x1.4ecb800p-13, -0x1.16c6000p-13, -0x1.d040800p-14,
    -0x1.8291800p-14, -0x1.41e2000p-14, -0x1.0c05800p-14, -0x1.be59000p-15,
    -0x1.73a9000p-15, -0x1.3578000p-15, -0x1.01af000p-15, -0x1.ad22000p-16,
    -0x1.6552000p-16, -0x1.2988000p-16, -0x1.ef7c000p-17, -0x1.9c94000p-17,
    -0x1.578c000p-17, -0x1.1e0c000p-17, -0x1.dc60000p-18, -0x1.8ca8000p-18,
    -0x1.4a48000p-18, -0x1.1300000p-18, -0x1.ca00000p-19, -0x1.7d60000p-19,
    -0x1.3d80000p-19, -0x1.0860000p-19, -0x1.b840000p-20, -0x1.6ea0000p-20,
    -0x1.3140000p-20, -0x1.fc40000p-21, -0x1.a740000p-21, -0x1.6080000p-21,
    -0x1.2580000p-21, -0x1.e880000p-22, -0x1.9700000p-22, -0x1.5280000p-22,
    -0x1.1a00000p-22, -0x1.d500000p-23, -0x1.8700000p-23, -0x1.4500000p-23,
    -0x1.0f00000p-23, -0x1.c200000p-24, -0x1.7800000p-24, -0x1.3800000p-24,
    -0x1.0400000p-24, -0x1.b000000p-25, -0x1.6800000p-25, -0x1.2c00000p-25,
    -0x1.f000000p-26, -0x1.a000000p-26, -0x1.5800000p-26, -0x1.2000000p-26,
    -0x1.e000000p-27, -0x1.9000000p-27, -0x1.4000000p-27, -0x1.1000000p-27,
    -0x1.c000000p-28, -0x1.8000000p-28, -0x1.4000000p-28, -0x1.0000000p-28,
    -0x1.8000000p-29, -0x1.4000000p-29, -0x1.0000000p-29, -0x1.0000000p-29,
    -0x1.8000000p-30, -0x1.0000000p-30, -0x1.0000000p-30, -0x1.0000000p-31,
    -0x1.0000000p-31, -0x1.0000000p-31, -0x1.0000000p-31, +0x0.0000000p-00,        
    -0x0.0000000p-00, +0x0.0000000p-00, +0x0.0000000p-00, +0x0.0000000p-00,
    -0x0.0000000p-00, +0x0.0000000p-00, +0x0.0000000p-00, +0x0.0000000p-00,
    -0x0.0000000p-00, -0x0.0000000p-00, +0x0.0000000p-00, +0x0.0000000p-00,
    +0x0.0000000p-00, +0x0.0000000p-00, +0x0.0000000p-00, +0x0.0000000p-00,
    +0x0.0000000p-00, +0x1.0000000p-31, +0x1.0000000p-31, +0x1.0000000p-31,
    +0x1.0000000p-31, +0x1.0000000p-30, +0x1.0000000p-30, +0x1.8000000p-30,
    +0x1.0000000p-29, +0x1.0000000p-29, +0x1.4000000p-29, +0x1.8000000p-29,
    +0x1.0000000p-28, +0x1.4000000p-28, +0x1.8000000p-28, +0x1.c000000p-28,
    +0x1.1000000p-27, +0x1.4000000p-27, +0x1.9000000p-27, +0x1.e000000p-27,
    +0x1.2000000p-26, +0x1.5800000p-26, +0x1.a000000p-26, +0x1.f000000p-26,
    +0x1.2c00000p-25, +0x1.6800000p-25, +0x1.b000000p-25, +0x1.0400000p-24,
    +0x1.3800000p-24, +0x1.7800000p-24, +0x1.c200000p-24, +0x1.0f00000p-23,
    +0x1.4500000p-23, +0x1.8700000p-23, +0x1.d500000p-23, +0x1.1a00000p-22,
    +0x1.5280000p-22, +0x1.9700000p-22, +0x1.e880000p-22, +0x1.2580000p-21,
    +0x1.6080000p-21, +0x1.a740000p-21, +0x1.fc40000p-21, +0x1.3140000p-20,
    +0x1.6ea0000p-20, +0x1.b840000p-20, +0x1.0860000p-19, +0x1.3d80000p-19,
    +0x1.7d60000p-19, +0x1.ca00000p-19, +0x1.1300000p-18, +0x1.4a48000p-18,
    +0x1.8ca8000p-18, +0x1.dc60000p-18, +0x1.1e0c000p-17, +0x1.578c000p-17,
    +0x1.9c94000p-17, +0x1.ef7c000p-17, +0x1.2988000p-16, +0x1.6552000p-16,
    +0x1.ad22000p-16, +0x1.01af000p-15, +0x1.3578000p-15, +0x1.73a9000p-15,
    +0x1.be59000p-15, +0x1.0c05800p-14, +0x1.41e2000p-14, +0x1.8291800p-14,
    +0x1.d040800p-14, +0x1.16c6000p-13, +0x1.4ecb800p-13, +0x1.9213000p-13,
    +0x1.e2dfc00p-13, +0x1.21f4c00p-12, +0x1.5c39800p-12, +0x1.a234000p-12,
    +0x1.f63e800p-12, +0x1.2d96300p-11, +0x1.6a31600p-11, +0x1.b2fa700p-11,
    +0x1.0531f00p-10, +0x1.39af280p-10, +0x1.78b8a80p-10, +0x1.c46d180p-10,
    +0x1.0fac1c0p-09, +0x1.46444c0p-09, +0x1.87d5200p-09, +0x1.d692f80p-09,
    +0x1.1a91d80p-08, +0x1.535aaa0p-08, +0x1.978cc20p-08, +0x1.e973300p-08,  
    +0x1.25e77c0p-07, +0x1.60f7680p-07, +0x1.a7e5ca0p-07, +0x1.fd153a0p-07,  
    +0x1.31b1840p-06, +0x1.6f1fee0p-06, +0x1.b8e6b00p-06, +0x1.08c0700p-05,  
    +0x1.3df49a0p-05, +0x1.7dd9d80p-05, +0x1.ca96300p-05, +0x1.135f1c0p-04,  
    +0x1.4ab59c0p-04, +0x1.8d2afa0p-04, +0x1.dcfb4e0p-04, +0x1.1e6ad40p-03,
    +0x1.57f9960p-03, +0x1.9d19660p-03, +0x1.f01d500p-03, +0x1.29e7fa0p-02,  
    +0x1.65c5c80p-02, +0x1.adab6a0p-02, +0x1.0201e60p-01, +0x1.35db1a0p-01,  
    +0x1.741fa80p-01, +0x1.bee7960p-01, +0x1.0000000p+00, +0x1.0000000p+00, 
};

/* int32_t test vector */
static const int32_t i32_from_f32[] = {
    -0x080000000, -0x080000000, -0x06fb9e580, -0x05d07ea00,       
    -0x04d76c680, -0x040807980, -0x035b56d40, -0x02cb8b900,       
    -0x0253cff40, -0x01f01d500, -0x019d19660, -0x0157f9960,       
    -0x011e6ad40, -0x00ee7da70, -0x00c6957d0, -0x00a55ace0,       
    -0x0089af8e0, -0x0072a58c0, -0x005f76760, -0x004f7d268,       
    -0x0042301c0, -0x00371cd60, -0x002de3fdc, -0x002636308,
    -0x001fd153a, -0x001a7e5ca, -0x00160f768, -0x00125e77c,       
    -0x000f4b998, -0x000cbc661, -0x000a9ad55, -0x0008d48ec,       
    -0x00075a4be, -0x00061f548, -0x000519113, -0x00043eb07,       
    -0x000388da3, -0x0002f1715, -0x0002735e5, -0x00020a63e,       
    -0x0001b2fa7, -0x00016a316, -0x00012d963, -0x0000fb1f4,       
    -0x0000d11a0, -0x0000ae1cc, -0x000090fa6, -0x000078b7f,       
    -0x00006484c, -0x000053b2e, -0x000045b18, -0x00003a081,       
    -0x000030523, -0x0000283c4, -0x00002180b, -0x00001be59,       
    -0x0000173a9, -0x000013578, -0x0000101af, -0x00000d691,       
    -0x00000b2a9, -0x0000094c4, -0x000007bdf, -0x000006725,       
    -0x0000055e3, -0x000004783, -0x000003b8c, -0x000003195,
    -0x000002949, -0x000002260, -0x000001ca0, -0x0000017d6,       
    -0x0000013d8, -0x000001086, -0x000000dc2, -0x000000b75,       
    -0x00000098a, -0x0000007f1, -0x00000069d, -0x000000582,       
    -0x000000496, -0x0000003d1, -0x00000032e, -0x0000002a5,       
    -0x000000234, -0x0000001d5, -0x000000187, -0x000000145,       
    -0x00000010f, -0x0000000e1, -0x0000000bc, -0x00000009c,       
    -0x000000082, -0x00000006c, -0x00000005a, -0x00000004b,       
    -0x00000003e, -0x000000034, -0x00000002b, -0x000000024,       
    -0x00000001e, -0x000000019, -0x000000014, -0x000000011,       
    -0x00000000e, -0x00000000c, -0x00000000a, -0x000000008,       
    -0x000000006, -0x000000005, -0x000000004, -0x000000004,       
    -0x000000003, -0x000000002, -0x000000002, -0x000000001,       
    -0x000000001, -0x000000001, -0x000000001, +0x000000000,
    +0x000000000, +0x000000000, +0x000000000, +0x000000000,       
    +0x000000000, +0x000000000, +0x000000000, +0x000000000,       
    +0x000000000, +0x000000000, +0x000000000, +0x000000000,       
    +0x000000000, +0x000000000, +0x000000000, +0x000000000,       
    +0x000000000, +0x000000001, +0x000000001, +0x000000001,       
    +0x000000001, +0x000000002, +0x000000002, +0x000000003,       
    +0x000000004, +0x000000004, +0x000000005, +0x000000006,       
    +0x000000008, +0x00000000a, +0x00000000c, +0x00000000e,       
    +0x000000011, +0x000000014, +0x000000019, +0x00000001e,       
    +0x000000024, +0x00000002b, +0x000000034, +0x00000003e,       
    +0x00000004b, +0x00000005a, +0x00000006c, +0x000000082,       
    +0x00000009c, +0x0000000bc, +0x0000000e1, +0x00000010f,       
    +0x000000145, +0x000000187, +0x0000001d5, +0x000000234,       
    +0x0000002a5, +0x00000032e, +0x0000003d1, +0x000000496,       
    +0x000000582, +0x00000069d, +0x0000007f1, +0x00000098a,       
    +0x000000b75, +0x000000dc2, +0x000001086, +0x0000013d8,       
    +0x0000017d6, +0x000001ca0, +0x000002260, +0x000002949,       
    +0x000003195, +0x000003b8c, +0x000004783, +0x0000055e3,       
    +0x000006725, +0x000007bdf, +0x0000094c4, +0x00000b2a9,       
    +0x00000d691, +0x0000101af, +0x000013578, +0x0000173a9,       
    +0x00001be59, +0x00002180b, +0x0000283c4, +0x000030523,       
    +0x00003a081, +0x000045b18, +0x000053b2e, +0x00006484c,       
    +0x000078b7f, +0x000090fa6, +0x0000ae1cc, +0x0000d11a0,
    +0x0000fb1f4, +0x00012d963, +0x00016a316, +0x0001b2fa7,       
    +0x00020a63e, +0x0002735e5, +0x0002f1715, +0x000388da3,       
    +0x00043eb07, +0x000519113, +0x00061f548, +0x00075a4be,       
    +0x0008d48ec, +0x000a9ad55, +0x000cbc661, +0x000f4b998,       
    +0x00125e77c, +0x00160f768, +0x001a7e5ca, +0x001fd153a,       
    +0x002636308, +0x002de3fdc, +0x00371cd60, +0x0042301c0,       
    +0x004f7d268, +0x005f76760, +0x0072a58c0, +0x0089af8e0,       
    +0x00a55ace0, +0x00c6957d0, +0x00ee7da70, +0x011e6ad40,       
    +0x0157f9960, +0x019d19660, +0x01f01d500, +0x0253cff40,       
    +0x02cb8b900, +0x035b56d40, +0x040807980, +0x04d76c680,
    +0x05d07ea00, +0x06fb9e580, +0x07fffffff, +0x07fffffff,   
};

/* perform test */
int TestFloatFixp_Init(void)
{   
    float one_fl; int32_t one_i32;

    /* buffer for the output */
    union {
        /* integers array */
        int32_t i32[elems(f32)];
        /* floating point array */
        float fl[elems(f32)];
    } output;

    /* test one value */
    one_fl = 1;
    /* test the number one value */
    FloatFixp_FloatToFixp32(&one_fl, 1, 23, &one_i32);
    /* check */
    assert(one_i32 == 1 << 23, "'one' test failed", one_i32);

    /* test negaitve one */
    one_fl = -1;
    /* test the number one value */
    FloatFixp_FloatToFixp32(&one_fl, 1, 23, &one_i32);
    /* check */
    assert(one_i32 == -(1 << 23), "'neg one' test failed", one_i32);


    /* convert float -> int32 */
    FloatFixp_FloatToFixp32(f32, elems(f32), 23, output.i32);
    /* sanity check */
    for (int i = 0 ; i < elems(f32); i++)
        assert(output.i32[i] == i32_from_f32[i], 
            "fl -> i32 mismatch @ index", i);
    
    /* convert int32 -> float */
    FloatFixp_Fixp32ToFloat(i32_from_f32, elems(i32_from_f32), 31, output.fl);
    /* sanity check */
    for (int i = 0 ; i < elems(f32_from_i32); i++)
        assert(f32_from_i32[i] == output.fl[i], 
            "i32 -> fl mismatch @ index", i);

    /* report status */
    return EOK;
}

/* poll test logic */
void TestFloatFixp_Poll(void)
{
}